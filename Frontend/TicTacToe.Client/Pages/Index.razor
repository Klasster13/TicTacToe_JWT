@page "/"

@rendermode RenderMode.InteractiveWebAssembly

@inject HttpClient Http
@inject NavigationManager Navigation
@inject ITokenStorageService TokenStorageService


<PageTitle>Tic-Tac-Toe</PageTitle>

<div class="top-bar">
    <a href="/about" class="nav-btn">About</a>
</div>

<div class="content-wrapper">
    <picture>
        <source srcset="header-image.webp" type="image/webp">
        <img src="header-image.jpg" alt="Welcome" class="header-image">
    </picture>

    <h1>Welcome!</h1>
    <AuthInputComponent IsSignIn="@true"></AuthInputComponent>
       

    <div style="margin-top: 10px;">
        <span >Don't have an account?</span>
        <a href="/signup" class="nav-btn">Sign Up</a>
    </div>
</div>

@code {

    protected override async Task OnInitializedAsync()
    {
        var refreshToken = await TokenStorageService.GetRefreshTokenAsync();

        if (!string.IsNullOrEmpty(refreshToken))
        {
            try
            {
                var response = await Http.PostAsJsonAsync("/auth/refresh-access",
                    new RefreshJwtRequest { RefreshToken = refreshToken }
                );

                if (response.IsSuccessStatusCode)
                {   
                    var jwtResponse = await response.Content.ReadFromJsonAsync<JwtResponse>();
                    if (jwtResponse is not null)
                    {
                        await TokenStorageService.SetTokensAsync(jwtResponse.AccessToken, jwtResponse.RefreshToken);
                        Navigation.NavigateTo($"/user");
                    } 
                    else
                    {
                        await TokenStorageService.ClearTokensAsync();
                    }
                }
                else
                {
                    await TokenStorageService.ClearTokensAsync();
                }
            }
            catch (Exception)
            {
                await TokenStorageService.ClearTokensAsync();
            }
        }        
    }
}